# CSAPP

## data-lab

æœªç‹¬ç«‹å®Œæˆçš„labéƒ¨åˆ†æ€è·¯è®°å½•

æ³¨æ„âš ï¸ï¼šæœ¬labä¸­çš„Cä»£ç ä¸º`C90/C89`æ ‡å‡†,æ‰€æœ‰å˜é‡å£°æ˜å¿…é¡»æ”¾åœ¨å‡½æ•°æˆ–ä»£ç å—çš„å¼€å¤´ï¼Œä¸”ä¸èƒ½åœ¨ä»£ç ä¸­å‡ºç°`0b`æ ‡è¯†çš„äºŒè¿›åˆ¶å¸¸æ•°ï¼Œå¦åˆ™å°½ç®¡å¯ä»¥é€šè¿‡æµ‹è¯•ï¼Œä½†æ˜¯`./dlc bits.c`è§„èŒƒä¼šæç¤º`parse error`æˆ–è€…å˜é‡å`undeclared`,æ­¤å¤–ä¹Ÿä¸è¦å‡ºç°æ²¡æœ‰ä½¿ç”¨è¿‡çš„å˜é‡

#### `int howManyBits(int x)`

```C
int howManyBits(int x) {
	int sign = x >> 31;
	// å¦‚æœæ˜¯è´Ÿæ•°å°±å–åï¼Œæ­£æ•°å°±ä¸å˜
	// æœ€åå°†æ‰€å¾—åˆ°çš„ä½æ•°åŠ ä¸Šç¬¦å·ä½è¿™ä¸€ä½å³å¯
	x = x ^ sign;

	int b16 = (!!(x >> 16)) << 4; // å¦‚æœé«˜16ä½æœ‰1ï¼Œé‚£ä¹ˆå°±è¯´æ˜è‡³å°‘éœ€è¦16ä½ï¼Œæ²¡1ç»“æœå°±æ˜¯0
	x = x >> b16; // å¦‚æœè‡³å°‘éœ€è¦16ä½ï¼Œé‚£æˆ‘ä»¬åªéœ€è¦å†åˆ¤æ–­é«˜16ä½ï¼›å¦‚æœä¸éœ€è¦ï¼Œé‚£æˆ‘ä»¬ä¾æ—§åˆ¤æ–­ä½16ä½

	// ä¸‹é¢åŒç†
	int b8 = (!!(x >> 8)) << 3;
	x = x >> b8;

	int b4 = (!!(x >> 4)) << 2;
	x = x >> b4;

	int b2 = (!!(x >> 2)) << 1;
	x = x >> b2;

	int b1 = (!!(x >> 1));
	x = x >> b1;

	int b0 = x;
	
	return b16 + b8 + b4 + b2 + b1 + b0 + 1;
}
```

#### `unsigned floatPower2(int x)`

è¿™ä¸ªpuzzleæœ¬ğŸ‰‘æ²¡æœ‰é€šè¿‡ï¼Œä¸çŸ¥é“æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´åœ¨æµ‹è¯•æ—¶é™·å…¥äº†æ— é™å¾ªç¯

ä½†æ˜¯ä¾ç„¶åœ¨è¿™é‡Œåˆ—å‡ºæ€è·¯ï¼Œä»¥ä¾¿åç»­çš„æ›´æ­£

é¦–å…ˆï¼Œé¢˜ç›®è¦æ±‚çš„æ˜¯2.0^x^ ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®xçš„èŒƒå›´å’ŒIEEE754æ ‡å‡†è¿›è¡Œåˆ†ç±»å’Œæ¯”å¯¹

|       x < -149        | ä¹Ÿå°±æ˜¯è¶…è¿‡äº†éè§„æ ¼æ•°èƒ½è¡¨ç¤ºçš„æœ€å°çš„2çš„å¹‚ | åœ¨éè§„æ ¼æ•°çš„æ ¼å¼ä¸‹ï¼Œ2çš„å¹‚ç”±fracå†³å®šï¼Œfracæœ€å°ä¸º0x000001å³ä¸º2^-23^ï¼Œæ•…èƒ½è¡¨ç¤ºçš„æœ€å°çš„2çš„å¹‚ä¸º2^-126-23^ å³2^-149^ |
| :-------------------: | --------------------------------------- | ------------------------------------------------------------ |
| **-149 <= x <= -126** | **ç”¨éè§„æ ¼æ•°è¿›è¡Œè¡¨ç¤º**                  |                                                              |
|  **-126 < x <= 127**  | **ç”¨è§„æ ¼æ•°è¿›è¡Œè¡¨ç¤º**                    | **åœ¨è§„æ ¼åŒ–ä¸‹ï¼Œ2.0çš„æµ®ç‚¹è¡¨ç¤ºä¸­exp=0b1000 0000ï¼Œè¦è¿›è¡Œå¹‚è¿ç®—ï¼Œåªéœ€è¦åœ¨expä¸ŠåŠ ä¸Šç›¸åº”çš„æŒ‡æ•°ï¼Œä¹Ÿå°±æ˜¯exp=127 + xï¼Œå…¶ä½™çš„ä½éƒ½æ˜¯0** |
|      **x > 127**      | **ç¬¬ä¸‰ç±»è¡¨ç¤ºæ³•**                        | **è¶…è¿‡äº†èƒ½è¡¨ç¤ºçš„æœ€å¤§å€¼ï¼Œè¿”å›0x7f800000**                     |

####  è¯„åˆ†ä¸€è§ˆ

```bash
Correctness Results     Perf Results
Points  Rating  Errors  Points  Ops     Puzzle
1       1       0       2       7       bitXor
1       1       0       2       1       tmin
1       1       0       2       10      isTmax
2       2       0       2       10      allOddBits
2       2       0       2       2       negate
3       3       0       2       11      isAsciiDigit
3       3       0       2       7       conditional
3       3       0       2       15      isLessOrEqual
4       4       0       2       9       logicalNeg
4       4       0       2       32      howManyBits
4       4       0       2       16      floatScale2
4       4       0       2       25      floatFloat2Int
0       0       0       0       0
0       0       0       0       0       10
0       4       1       0       9       floatPower2

Score = 56/62 [32/36 Corr + 24/26 Perf] (154 total operators)
```

## bomblab

å¸¸è§GDBå‘½ä»¤ä»¥åŠæœ¬labéœ€è¦ç”¨çš„å‘½ä»¤æ±‡æ€»åœ¨[è¿™ä¸ªåšå®¢](https://arthals.ink/blog/bomb-lab#%E9%98%85%E8%AF%BB%E6%BA%90%E7%A0%81)çš„ç¬¬ä¸€éƒ¨åˆ†ï¼Œè¯¥åšå®¢çš„å‰©ä½™éƒ¨åˆ†æ˜¯åŒ—å¤§ICSçš„labå®ç°

å®ç°æ€è·¯ä»‹ç»

âš ï¸ï¼šåº”å…ˆè‡ªå·±å°è¯•

### phase_1

```assembly
0000000000400ee0 <phase_1>:
  400ee0:	48 83 ec 08          	sub    $0x8,%rsp
  400ee4:	be 00 24 40 00       	mov    $0x402400,%esi
  400ee9:	e8 4a 04 00 00       	call   401338 <strings_not_equal>
  400eee:	85 c0                	test   %eax,%eax
  400ef0:	74 05                	je     400ef7 <phase_1+0x17>
  400ef2:	e8 43 05 00 00       	call   40143a <explode_bomb>
  400ef7:	48 83 c4 08          	add    $0x8,%rsp
  400efb:	c3                   	ret
```

phase_1æ²¡æœ‰é‚£ä¹ˆéš¾ï¼Œæ ¸å¿ƒä»£ç å°±æ˜¯è¿›å…¥åˆ°`strings_not_equal`ï¼Œè¿™ä¸ªå‡½æ•°ä¼šåˆ¤æ–­è¾“å…¥å­—ç¬¦ä¸²å’Œæ ‡å‡†å­—ç¬¦ä¸²æ˜¯å¦ä¸€è‡´ï¼Œæ ¹æ®è¿”å›å€¼æ¥å†³å®šç‚¸å¼¹æ˜¯å¦å¼•çˆ†ã€‚**å› è€Œæˆ‘ä»¬åªéœ€è¦æ‰¾åˆ°æ ‡å‡†å­—ç¬¦ä¸²æ‰€åœ¨çš„åœ°å€ï¼Œç„¶åæ‰“å°å‡ºæ¥å³å¯**

```assembly
0000000000401338 <strings_not_equal>:
  401338:	41 54                	push   %r12
  40133a:	55                   	push   %rbp
  40133b:	53                   	push   %rbx
  40133c:	48 89 fb             	mov    %rdi,%rbx
  40133f:	48 89 f5             	mov    %rsi,%rbp
  401342:	e8 d4 ff ff ff       	call   40131b <string_length>
  401347:	41 89 c4             	mov    %eax,%r12d
  40134a:	48 89 ef             	mov    %rbp,%rdi
  40134d:	e8 c9 ff ff ff       	call   40131b <string_length>
  401352:	ba 01 00 00 00       	mov    $0x1,%edx
  401357:	41 39 c4             	cmp    %eax,%r12d
  40135a:	75 3f                	jne    40139b <strings_not_equal+0x63>
  40135c:	0f b6 03             	movzbl (%rbx),%eax
  40135f:	84 c0                	test   %al,%al				#%alæ˜¯ç©ºï¼Œè¯´æ˜æ¯”è¾ƒå®Œæ¯•ï¼Œåˆ™å°†%eaxè®¾ç½®ä¸º0
  401361:	74 25                	je     401388 <strings_not_equal+0x50>
  401363:	3a 45 00             	cmp    0x0(%rbp),%al 	#%alä¸ä¸ºç©ºï¼Œé‚£å°±è·Ÿï¼ˆ%rbxï¼‰æ¯”è¾ƒï¼Œæ­¤æ—¶å·²ç»å¯ä»¥çœ‹å‡ºï¼Œæ ‡å‡†å­—ç¬¦ä¸²å‚¨å­˜åœ¨%rbpä¸­ï¼Œç›¸ç­‰å°±å¾ªç¯æ¯”è¾ƒå‰©ä½™éƒ¨åˆ†ï¼Œä¸ç›¸ç­‰ç›´æ¥è®¾ç½®ç»“æœé€€å‡ºå‡½æ•°
  401366:	74 0a                	je     401372 <strings_not_equal+0x3a>
  401368:	eb 25                	jmp    40138f <strings_not_equal+0x57>
  40136a:	3a 45 00             	cmp    0x0(%rbp),%al
  40136d:	0f 1f 00             	nopl   (%rax)
  401370:	75 24                	jne    401396 <strings_not_equal+0x5e>
  401372:	48 83 c3 01          	add    $0x1,%rbx
  401376:	48 83 c5 01          	add    $0x1,%rbp
  40137a:	0f b6 03             	movzbl (%rbx),%eax
  40137d:	84 c0                	test   %al,%al
  40137f:	75 e9                	jne    40136a <strings_not_equal+0x32>
  401381:	ba 00 00 00 00       	mov    $0x0,%edx
  401386:	eb 13                	jmp    40139b <strings_not_equal+0x63>
  401388:	ba 00 00 00 00       	mov    $0x0,%edx
  40138d:	eb 0c                	jmp    40139b <strings_not_equal+0x63>
  40138f:	ba 01 00 00 00       	mov    $0x1,%edx
  401394:	eb 05                	jmp    40139b <strings_not_equal+0x63>
  401396:	ba 01 00 00 00       	mov    $0x1,%edx
  40139b:	89 d0                	mov    %edx,%eax
  40139d:	5b                   	pop    %rbx
  40139e:	5d                   	pop    %rbp
  40139f:	41 5c                	pop    %r12
  4013a1:	c3                   	ret
```

è¿›å…¥åˆ°è¿™ä¸ªequalå‡½æ•°ï¼Œå…ˆå¾—åˆ°æ ‡å‡†å­—ç¬¦ä¸²å’Œè¾“å…¥å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œé•¿åº¦ä¸ä¸€æ ·ç›´æ¥`%rax` è®¾ç½®ä¸º`%edx`, ä¹Ÿå°±æ˜¯1ï¼›

`401357:	41 39 c4             	cmp    %eax,%r12d`

å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸¤ä¸ªé•¿åº¦åˆ†åˆ«å­˜å‚¨åœ¨`%eax å’Œ %r12d`ä¸­

ç„¶å`40135c:	0f b6 03             	movzbl (%rbx),%eax`å°†å­—ç¬¦ä¸²ä¸­çš„ä¸€ä¸ªå­—ç¬¦ç§»åŠ¨åˆ°`%eax`ä¸­ 

è¿›è¡Œæ¯”è¾ƒå³å¯ï¼ˆè§æ³¨é‡Šï¼‰

### phase_2

Phase_2å…¶å®ä¸éœ€è¦ç†è§£å…¨éƒ¨ä»£ç ï¼Œç‰¹åˆ«æ˜¯`read_six_numbers`ä¸­çš„ä»£ç ï¼Œå› ä¸ºå¤§éƒ¨åˆ†éƒ½æ˜¯å¯¹å†…å­˜çš„ç®¡ç†ï¼Œæ–¹ä¾¿è¯»å…¥æ•°å­—

å¦‚ä½ æ‰€è§ï¼Œæœ‰``read_six_numbers``è¯´æ˜è¯¥é˜¶æ®µè¦è¯»å…¥6ä¸ªæ•°å­—ï¼ˆå½“ä½ è¯»äº†æ±‡ç¼–ç ä¹‹åå‘ç°ç¡®å®æ˜¯è¿™æ ·ï¼‰

é‡ç‚¹æ€è·¯æ ‡æ³¨åœ¨æ³¨é‡Šé‡Œ

```assembly
0000000000400efc <phase_2>:
  400efc:	55                   	push   %rbp
  400efd:	53                   	push   %rbx
  400efe:	48 83 ec 28          	sub    $0x28,%rsp
  400f02:	48 89 e6             	mov    %rsp,%rsi
  400f05:	e8 52 05 00 00       	call   40145c <read_six_numbers>
  400f0a:	83 3c 24 01          	cmpl   $0x1,(%rsp)				#ï¼ˆ%rspï¼‰çš„å€¼åªä¼šæ˜¯1ï¼Œä¸ç„¶ä¼šå¼•çˆ†ç‚¸å¼¹
  400f0e:	74 20                	je     400f30 <phase_2+0x34>
  400f10:	e8 25 05 00 00       	call   40143a <explode_bomb>
  400f15:	eb 19                	jmp    400f30 <phase_2+0x34>
  400f17:	8b 43 fc             	mov    -0x4(%rbx),%eax 		#%eaxå­˜å‚¨çš„æ˜¯%rbxåœ°å€å¤„çš„ä¸Šä¸€ä¸ªint
  400f1a:	01 c0                	add    %eax,%eax					#ä¹˜2
  400f1c:	39 03                	cmp    %eax,(%rbx)				# æ¯”è¾ƒ2å€çš„%rbxåœ°å€å¤„çš„ä¸Šä¸€ä¸ªint å’Œ %rbxæŒ‡å‘çš„int
  400f1e:	74 05                	je     400f25 <phase_2+0x29> 		# ç›¸ç­‰å°±å¾ªç¯ï¼Œä¸ç­‰ç›´æ¥çˆ†
  400f20:	e8 15 05 00 00       	call   40143a <explode_bomb>
  400f25:	48 83 c3 04          	add    $0x4,%rbx 					# %rbxæŒ‡å‘ä¸‹ä¸€ä¸ªint
  400f29:	48 39 eb             	cmp    %rbp,%rbx 					# æ¯”è¾ƒ%rbxå’Œ%rbpä½œä¸ºå¾ªç¯æ¡ä»¶
  400f2c:	75 e9                	jne    400f17 <phase_2+0x1b>
  400f2e:	eb 0c                	jmp    400f3c <phase_2+0x40>
  400f30:	48 8d 5c 24 04       	lea    0x4(%rsp),%rbx 		#ä»è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºæ˜¯6ä¸ªæ•°
  400f35:	48 8d 6c 24 18       	lea    0x18(%rsp),%rbp 
  400f3a:	eb db                	jmp    400f17 <phase_2+0x1b>
  400f3c:	48 83 c4 28          	add    $0x28,%rsp
  400f40:	5b                   	pop    %rbx
  400f41:	5d                   	pop    %rbp
  400f42:	c3                   	ret
```

æ ¹æ®æ³¨é‡Šåˆ†æï¼Œæˆ‘ä»¬è¦è¾“å…¥çš„æ˜¯ä¸€ä¸ª6é¡¹ç­‰æ¯”æ•°åˆ—ï¼Œæ¯”ä¸º2ï¼Œç”±äºå¾ªç¯å‰çš„æ¯”è¾ƒæ—¶%rspçš„å€¼åªä¼šæ˜¯1ï¼Œä¸” ç¬¬ä¸€æ¬¡å¾ªç¯æœ‰ï¼š

`lea    0x4(%rsp),%rbx` `	mov    -0x4(%rbx),%eax`

æ•…è¯¥æ•°åˆ—çš„é¦–ç›¸ä¸º1

å³å¯å¾—åˆ°ç­”æ¡ˆ

### Phase_3

è¿™ä¸€é˜¶æ®µå…¶å®å°±æ˜¯è¾“å…¥ä¸¤ä¸ªæ•°å­—ï¼Œç¬¬ä¸€ä¸ªæ•°å­—å†³å®šäº†switchè¯­å¥çš„caseï¼Œç¬¬äºŒä¸ªæ•°å­—ç”¨äºåˆ¤æ–­æ˜¯å¦æˆåŠŸå¯¹åº”äº†ç›¸åº”çš„caseï¼Œç­”æ¡ˆä¸ç»Ÿä¸€ï¼Œå¯¹åº”ä¸Šå³å¯

```assembly
0000000000400f43 <phase_3>:
  400f43:	48 83 ec 18          	sub    $0x18,%rsp
  400f47:	48 8d 4c 24 0c       	lea    0xc(%rsp),%rcx
  400f4c:	48 8d 54 24 08       	lea    0x8(%rsp),%rdx
  400f51:	be cf 25 40 00       	mov    $0x4025cf,%esi
  400f56:	b8 00 00 00 00       	mov    $0x0,%eax
  400f5b:	e8 90 fc ff ff       	call   400bf0 <__isoc99_sscanf@plt>
  400f60:	83 f8 01             	cmp    $0x1,%eax 								#%eaxä¸­å‚¨å­˜äº†scanfè¯»å–æˆåŠŸçš„ä¸ªæ•°
  400f63:	7f 05                	jg     400f6a <phase_3+0x27>		#è¦æ±‚è‡³å°‘è¯»å…¥2ä¸ªæ•°(å®æµ‹å¤šè¾“å…¥å‡ ä¸ªæ•°å­—ä¹Ÿæ— æ‰€è°“)
  400f65:	e8 d0 04 00 00       	call   40143a <explode_bomb>		#å¦åˆ™å¼•çˆ†
  400f6a:	83 7c 24 08 07       	cmpl   $0x7,0x8(%rsp)						#è¯»è¿›å»çš„ä¸¤ä¸ªæ•°åˆ†åˆ«ä½äº%rsp+0x8çš„ä½4å­—èŠ‚å’Œé«˜4å­—èŠ‚
  400f6f:	77 3c                	ja     400fad <phase_3+0x6a>		#è¦æ±‚ç¬¬ä¸€ä¸ªæ•°ä¸èƒ½å¤§äº7ï¼Œå¦åˆ™å¼•çˆ†
  400f71:	8b 44 24 08          	mov    0x8(%rsp),%eax						#å°†ç¬¬ä¸€ä¸ªæ•°ä¼ å…¥%eaxä¸­
  400f75:	ff 24 c5 70 24 40 00 	jmp    *0x402470(,%rax,8)				#é€šè¿‡è·³è½¬è¡¨è¿›è¡Œå¯¹åº”switchçš„case
  400f7c:	b8 cf 00 00 00       	mov    $0xcf,%eax								
  400f81:	eb 3b                	jmp    400fbe <phase_3+0x7b>
  400f83:	b8 c3 02 00 00       	mov    $0x2c3,%eax
  400f88:	eb 34                	jmp    400fbe <phase_3+0x7b>
  400f8a:	b8 00 01 00 00       	mov    $0x100,%eax
  400f8f:	eb 2d                	jmp    400fbe <phase_3+0x7b>
  400f91:	b8 85 01 00 00       	mov    $0x185,%eax
  400f96:	eb 26                	jmp    400fbe <phase_3+0x7b>
  400f98:	b8 ce 00 00 00       	mov    $0xce,%eax
  400f9d:	eb 1f                	jmp    400fbe <phase_3+0x7b>
  400f9f:	b8 aa 02 00 00       	mov    $0x2aa,%eax
  400fa4:	eb 18                	jmp    400fbe <phase_3+0x7b>
  400fa6:	b8 47 01 00 00       	mov    $0x147,%eax
  400fab:	eb 11                	jmp    400fbe <phase_3+0x7b>
  400fad:	e8 88 04 00 00       	call   40143a <explode_bomb>
  400fb2:	b8 00 00 00 00       	mov    $0x0,%eax
  400fb7:	eb 05                	jmp    400fbe <phase_3+0x7b>
  400fb9:	b8 37 01 00 00       	mov    $0x137,%eax
  400fbe:	3b 44 24 0c          	cmp    0xc(%rsp),%eax
  400fc2:	74 05                	je     400fc9 <phase_3+0x86>
  400fc4:	e8 71 04 00 00       	call   40143a <explode_bomb>
  400fc9:	48 83 c4 18          	add    $0x18,%rsp
  400fcd:	c3                   	ret
```

æ‹¿è¾“å…¥ä¸º`6 682`ä¸¾ä¾‹

ç¬¬ä¸€ä¸ªæ•°å­—ä¸º6ï¼Œé‚£å°±è·³è½¬åˆ°ç¬¬6ä¸ªcaseï¼ˆç´¢å¼•ä»1å¼€å§‹ï¼‰ï¼Œç„¶å`mov    $0x2aa,%eax `å°†%eaxè®¾ç½®ä¸º0x2aaä¹Ÿå°±æ˜¯10è¿›åˆ¶çš„682ï¼ˆæ³¨æ„ï¼š**è¾“å…¥çš„æ—¶å€™è¦è¾“å…¥10è¿›åˆ¶è‹¥è¾“å…¥0x2aaä¼šç”±äºæ ¼å¼ä¸æ­£ç¡®å¯¼è‡´å¼•çˆ†**ï¼‰,ç„¶åè·³è½¬ã€æ¯”è¾ƒ

`cmp    0xc(%rsp),%eax`è¿™é‡Œçš„0xc(%rsp)çš„ä½4ä¸ªå­—èŠ‚å…¶å®å°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„ç¬¬äºŒä¸ªæ•°

### Phase_4

ä¸»ä½“é€»è¾‘å¾ˆæ˜æ˜¾ï¼Œè¾“å…¥ä¸¤ä¸ªæ•°ï¼Œç»è¿‡func4è¿ç®—ç»“æœåº”è¯¥ä¸º0ï¼Œä¸”ç¬¬äºŒä¸ªè¾“å…¥çš„æ•°å­—ä¹Ÿè¦ä¸º0

```assembly
000000000040100c <phase_4>:
  40100c:	48 83 ec 18          	sub    $0x18,%rsp
  401010:	48 8d 4c 24 0c       	lea    0xc(%rsp),%rcx
  401015:	48 8d 54 24 08       	lea    0x8(%rsp),%rdx
  40101a:	be cf 25 40 00       	mov    $0x4025cf,%esi
  40101f:	b8 00 00 00 00       	mov    $0x0,%eax
  401024:	e8 c7 fb ff ff       	call   400bf0 <__isoc99_sscanf@plt>
  401029:	83 f8 02             	cmp    $0x2,%eax
  40102c:	75 07                	jne    401035 <phase_4+0x29>   # ä¸ç­‰äº2ç›´æ¥çˆ†ç‚¸
  40102e:	83 7c 24 08 0e       	cmpl   $0xe,0x8(%rsp)          # å°†è¾“å…¥çš„ç¬¬ä¸€ä¸ªæ•°å­—è·Ÿ0xeæ¯”è¾ƒ
  401033:	76 05                	jbe    40103a <phase_4+0x2e>   # å¤§äºå°±ç‚¸
  401035:	e8 00 04 00 00       	call   40143a <explode_bomb>
  40103a:	ba 0e 00 00 00       	mov    $0xe,%edx               
  40103f:	be 00 00 00 00       	mov    $0x0,%esi
  401044:	8b 7c 24 08          	mov    0x8(%rsp),%edi
  401048:	e8 81 ff ff ff       	call   400fce <func4>
  40104d:	85 c0                	test   %eax,%eax
  40104f:	75 07                	jne    401058 <phase_4+0x4c>
  401051:	83 7c 24 0c 00       	cmpl   $0x0,0xc(%rsp)
  401056:	74 05                	je     40105d <phase_4+0x51>
  401058:	e8 dd 03 00 00       	call   40143a <explode_bomb>
  40105d:	48 83 c4 18          	add    $0x18,%rsp
  401061:	c3                   	ret
```

ä¼ å…¥funcçš„å‚æ•°æ˜¯14å’Œ0ä»¥åŠæˆ‘ä»¬è¾“å…¥çš„ç¬¬ä¸€ä¸ªæ•°

æˆ‘çš„åšæ³•æ˜¯è§‚å¯Ÿåˆ°å½“è¾“å…¥çš„ä¸€ä¸ªæ•°ä¸º7æ˜¯func4æ­£å¥½è¿”å›0

ç„¶åé€šè¿‡GPTå¾—åˆ°Cè¯­è¨€ç‰ˆæœ¬å¦‚ä¸‹ï¼š

```C
int func4(int target, int low, int high) {
    if (low > high) {
        return 0;
    }

    int mid = (high - low) / 2 + low;

    if (target < mid) {
        return 2 * func4(target, low, mid - 1);
    } else if (target > mid) {
        return 2 * func4(target, mid + 1, high) + 1;
    } else {
        return 0;
    }
}
```

å…¶å®å°±æ˜¯ä¸€ä¸ªäºŒåˆ†æŸ¥æ‰¾è¿”å›è·¯å¾„ç¼–ç ï¼Œåªæœ‰å½“targetä¸º7æ˜¯æ‰ä¼šè¿”å›0

è¡¥ï¼šå¯èƒ½æœ‰å…¶ä»–ç­”æ¡ˆ

### Phase_5

å­—ç¬¦ä¸²è§£ç é—®é¢˜ï¼Œæ ¹æ®phase_1çš„ç»éªŒæˆ‘ä»¬å¾ˆå®¹æ˜“å¾—åˆ°æ ‡å‡†å­—ç¬¦ä¸²ï¼Œä½†æ˜¯phase_5çš„ä»£ç å¯¹è¾“å…¥å­—ç¬¦ä¸²è¿›è¡Œäº†åŠ å¯†ï¼Œå¦‚ä½•è¿›è¡Œè§£å¯†ï¼Ÿæˆ‘çš„åšæ³•æ˜¯ **æš´åŠ›æšä¸¾**ï¼Œç”±äºæ²¡æœ‰æ‰¾åˆ°åˆç†çš„åŠ å¯†è§„å¾‹ï¼Œæˆ‘é€‰æ‹©äº†å¯¹å­—ç¬¦ä¸€ä¸€è¿›è¡ŒåŠ å¯†å¾—åˆ°å¯¹åº”çš„å­—ç¬¦ï¼Œç„¶åæ‹¼æ¥æˆåŠ å¯†åå¯ä»¥å¾—åˆ°æ ‡å‡†å­—ç¬¦ä¸²çš„è¾“å…¥å­—ç¬¦ä¸²ï¼Œæœ€åæˆåŠŸè§£ç 

è¡¥ï¼š

åæ¥åœ¨çœ‹bç«™çš„æ—¶å€™æœ‰äº†æƒ³æ³•ï¼Œåº”è¯¥åªè¦æ˜¯asciiç ä½4ä½æ˜¯æ ‡å‡†å­—ç¬¦ä¸²å¯¹åº”çš„ç å€¼å³å¯

### Phase_6

Phase_6çœ‹äº†åŠå¤©æ²¡åšå‡ºæ¥ã€‚æ±‡ç¼–ç è¯»æ‡‚äº†ä¸€éƒ¨åˆ†ï¼Œç†è§£äº†è¾“å…¥1-6 ä¸€å…±6ä¸ªæ•°å­—ï¼Œç„¶åç”¨7å»å‡ï¼Œå¡åœ¨äº†é“¾è¡¨é‚£é‡Œï¼Œæ­»æ´»æ²¡å¼„æ˜ç™½é“¾è¡¨æ€ä¹ˆæ„å»ºçš„ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸æ”¾è§£æäº†ï¼Œç›¸å…³è§£æå¯ä»¥ç§»æ­¥åˆ°[bç«™](https://www.bilibili.com/video/BV1vu411o7QP?t=0.6&p=7)

## attacklab

å¥½å§ï¼Œè¿™ä¸ªlabæ²¡èƒ½ç‹¬ç«‹åšå‡ºæ¥ï¼ŒåŸå› æ˜¯å¯¹æ ˆæº¢å‡ºå’ŒROPç†è§£ä¸æ˜¯å¾ˆåˆ°ä½ï¼Œä¹Ÿæ²¡æœ‰å¯¹`ret push pop`è¿™äº›æŒ‡ä»¤ç‰¹åˆ«ç†Ÿæ‚‰ã€‚æ€»çš„æ¥è¯´å°±æ˜¯å¯¹æ ˆçš„è¡Œä¸ºéƒ½ä¸å¤ªç†ŸğŸ™‚â€â†•ï¸

æ ¹æ®å‚è€ƒä¸‹æ¥çš„æ–‡æ¡£[å®˜æ–¹writeup](https://csapp.cs.cmu.edu/3e/attacklab.pdf)ï¼Œ [arthalsâ€˜inkåšå®¢](https://arthals.ink/blog/attack-lab#phase-1)ï¼Œ[bç«™](ã€æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ attacklab-å“”å“©å“”å“©ã€‘ https://b23.tv/WyDNvzY)

å†æ¢³ç†ä¸€ä¸‹å·¥ä½œæµå§

**å‰ä¸‰ä¸ªé˜¶æ®µæ˜¯é€šè¿‡ä»£ç æ³¨å…¥æ¥æ”»å‡»ç¨‹åº**

å…ˆæ‰§è¡Œä»¥ä¸‹å‘½ä»¤

```bash
# å°†ctargetåæ±‡ç¼–
objdump -d ctarget > ctarget.asm
```

### Phase_1

æœ¬é˜¶æ®µè¦æ±‚å½“`getbuf()`ç»“æŸæ—¶è·³è½¬åˆ°`touch1()`ï¼Œæˆ‘ä»¬éœ€è¦è¿™æ ·åš

- æŸ¥çœ‹`ctarget.asm`ä¸­çš„`getbuf()`å¾—åˆ°ç¼“å†²åŒºå¤§å°

- ç¼–å†™æˆ‘ä»¬çš„å­—ç¬¦ä¸²

  - å‰é¢çš„ç¼“å†²åŒºå†…éšä¾¿å¡«
  - ä½†æ˜¯è¶…å‡ºç¼“å†²åŒº4ä¸ªå­—èŠ‚çš„éƒ¨åˆ†å†™ä¸Š`touch1()`çš„èµ·å§‹åœ°å€ï¼Œæ³¨æ„è¦åç€å†™ï¼ˆå°ç«¯ï¼‰

- è¾“å…¥ä¸‹é¢çš„å‘½ä»¤å³å¯

  `./hex2raw -i input.txt | ./ctarget -q`

  `input.txt`æ›¿æ¢ä¸ºä½ è‡ªå·±çš„å­—ç¬¦ä¸²è¾“å…¥æ–‡ä»¶

### Phase_2

æœ¬é˜¶æ®µè¦æ±‚ä¸ºå‚æ•°å¯„å­˜å™¨èµ‹å€¼ï¼Œå°†ä»£ç æ³¨å…¥åˆ°ç¼“å†²åŒºç„¶åæ‰§è¡Œæ³¨å…¥ä»£ç ï¼Œå³è·³åˆ°`touch2()`ï¼Œå·¥ä½œæµå¦‚ä¸‹ï¼š

- ç¼–å†™æ±‡ç¼–ç ï¼Œå†…å®¹æ˜¯ï¼š
  - å°†`touch2()`çš„èµ·å§‹åœ°å€`push`åˆ°æ ˆ
  - å°†`cookie`ä¼ é€’åˆ°`%rdi`å¯„å­˜å™¨
  - è¿”å›`ret`
  - åŸå› æ˜¯ï¼Œæˆ‘ä»¬é€šè¿‡å‹å…¥ä¸€ä¸ªåœ°å€ï¼Œ`ret`è¯­å¥ä¼šä»æ ˆä¸­å–å‡ºè¿™ä¸ªåœ°å€ç„¶åè·³è½¬
- ç„¶åè¾“å…¥å‘½ä»¤
  - `gcc -c p2.s # ç¼–è¯‘ `
  - `objdump -d p2.o > p2.d # ç¿»è¯‘ä¸ºå­—èŠ‚ç ,p2.dåç¼€æ— æ‰€è°“`

- é€šè¿‡`p2.d`æ–‡ä»¶å¾—åˆ°æŒ‡ä»¤çš„å­—èŠ‚ç 

- æŠŠè¿™ä¸ªå­—èŠ‚ç å¡«å…¥è¾“å…¥å­—ç¬¦ä¸²çš„é¦–éƒ¨

  - ç›´æ¥å†™ä¸éœ€è¦å€’åºï¼ˆåŸå› æ˜¯æ±‡ç¼–æŒ‡ä»¤æœ¬èº«å·²ç»æ˜¯**æŒ‰å­—èŠ‚åºåˆ—æ’å¥½**çš„æœºå™¨ç ï¼Œé€å­—èŠ‚è¯»å…¥å³å¯ï¼‰
  - æŒ‡ä»¤å­—èŠ‚ç ä¹‹é—´ä¸éœ€è¦åˆ†éš”

- å‰©ä¸‹çš„ç¼“å†²åŒºå¡«00å³å¯

- è¶…å‡ºç¼“å†²åŒºçš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬ç”¨ç¼“å†²åŒºçš„èµ·å§‹åœ°å€è¿›è¡Œè¦†ç›–ï¼Œè¿™æ ·æ‰èƒ½è·³è½¬åˆ°æˆ‘ä»¬çš„æ³¨å…¥ä»£ç 

  - è¦è·å¾—ç¼“å†²åŒºçš„èµ·å§‹åœ°å€ï¼Œæ‰¾åˆ°åˆ†é…ç¼“å†²åŒºç©ºé—´åçš„æ ˆæŒ‡é’ˆå³å¯

  - ä½¿ç”¨gdbè¿›è¡ŒæŸ¥çœ‹

  - ```bash
    gdb ctarget
    b getbuf
    r -q # è¦å¸¦ -qå¦åˆ™ä¼šæ£€æµ‹åˆ°å®¿ä¸»æœºåç§°
    ```

- è¾“å…¥ä¸‹é¢çš„å‘½ä»¤å³å¯

  `./hex2raw -i input.txt | ./ctarget -q`

  `input.txt`æ›¿æ¢ä¸ºä½ è‡ªå·±çš„å­—ç¬¦ä¸²è¾“å…¥æ–‡ä»¶

### Phase_3

æ­£å¸¸çš„å·¥ä½œæµåº”è¯¥æ˜¯ï¼š

- ä¿®æ”¹ç¬¬äºŒé˜¶æ®µçš„ç­”æ¡ˆä½¿å¾—ç¨‹åºè¿›å…¥`touch3()`è¿›è¡Œæµ‹è¯•ï¼Œçœ‹è°ƒç”¨`hexmatch()`å‰åçš„ç¼“å­˜åŒºå˜åŒ–æƒ…å†µæ¥åˆ¤æ–­è¯¥å‡½æ•°å¯¹ç¼“å­˜åŒºçš„è¦†ç›–èŒƒå›´
- ç„¶åå°†æˆ‘ä»¬çš„å­—ç¬¦ä¸²æ”¾åˆ°ä¸ä¼šè¢«å½±å“çš„ç¼“å­˜åŒºåŒºåŸŸ
- æœ€åç¼–å†™æ±‡ç¼–ç è¿›è¡Œæµ‹è¯•
  - å…ˆå°†`touch3()`åœ°å€å…¥æ ˆ
  - ç„¶åå°† **æˆ‘ä»¬çš„å­—ç¬¦ä¸²åœ°å€**ä¼ å…¥`%rdi`ä¸­
  - æœ€åè¿”å›å³å¯

- ç„¶åæŒ‰ç…§ä¸Šé¢çš„å¾—åˆ°çš„åœ°å€ä¿¡æ¯å»ç»„ç»‡è¾“å…¥å­—ç¬¦ä¸²å³å¯

ä½†æ˜¯æˆ‘é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œä¹Ÿå°±æ˜¯åœ¨ç¡®å®šç­”æ¡ˆå‰è¿›è¡Œæµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘é‡åˆ°äº†æ®µé”™è¯¯ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘æ²¡æœ‰åŠæ³•åˆ©ç”¨gdbè§‚å¯Ÿç¼“å­˜åŒºåŸŸçš„å˜åŒ–ï¼Œå¯¼è‡´æˆ‘æ²¡åšå‡ºæ¥ã€‚

å¦ä¸€ç§æ€è·¯ï¼šæ¥è‡ª[bç«™](ã€æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ attacklab-å“”å“©å“”å“©ã€‘ https://b23.tv/WyDNvzY) upä¸»çš„è¯„è®ºï¼š

```
å›å¤ @é›¨éšé£æ¥é›¨è½å» :ä½ çœ‹ä¸‹hexmatchçš„ä»£ç ï¼Œcbufæ•°ç»„å…¶å®å°±æ˜¯getbufçš„æ ˆå¸§ï¼Œså­—ç¬¦ä¸²çš„èµ·å§‹åœ°å€æ˜¯cbufçš„é¦–åœ°å€åŠ ä¸Šä¸€ä¸ªéšæœºæ•°å¯¹100æ±‚ä½™å‰©ä¸‹çš„ä½™æ•°ï¼Œä½™æ•°èŒƒå›´0åˆ°99ï¼Œså­—ç¬¦ä¸²æœ¬èº«å ç”¨8å­—èŠ‚ï¼Œé‚£ä¹ˆï¼Œcbufæ•°ç»„å¯èƒ½0-107å­—èŠ‚è¿™ä¸ªèŒƒå›´éƒ½å¯èƒ½è¢«så­—ç¬¦ä¸²è¦†ç›–ï¼Œåªå‰©ä¸‹æœ€åä¸¤ä¸ªå­—èŠ‚æ˜¯ä¸ä¼šè¢«è¦†ç›–çš„ï¼Œä½†æ˜¯æˆ‘ä»¬è¦å­˜çš„å­—ç¬¦æ•°ç»„é•¿8å­—èŠ‚ï¼Œå‰©ä¸‹ä¸¤ä¸ªå­—èŠ‚ä¸å¤Ÿç”¨ï¼Œæ‰€ä»¥åªèƒ½æ”¾åˆ°testçš„æ ˆå¸§é‡Œäº†ã€‚
```

### **phase_4,phase_5**

è¿™ä¸¤ä¸ªé˜¶æ®µåˆ©ç”¨çš„æŠ€æœ¯æ˜¯ **ROP**

åŸºæœ¬å·¥ä½œæµæ˜¯ï¼š

- å…ˆæ‰§è¡Œ`objdump -d rtarget > rtarget.asm`

- åœ¨`rtarget.asm`ä¸­æ‰¾åˆ°`<start_farm>`ä¸`<end_farm>`ï¼Œè¿™ä¹‹é—´çš„æŒ‡ä»¤æ˜¯æˆ‘ä»¬å¯ä»¥å»ç”¨çš„
- ç„¶åç¡®å®šä½ è¦æ‰§è¡Œçš„æŒ‡ä»¤
- å¯¹åº”è¡¨æ ¼æ‰¾åˆ°ç›¸å…³æŒ‡ä»¤çš„å­—èŠ‚ç 
- åœ¨`<start_farm>`ä¸`<end_farm>`é—´æ£€ç´¢å¯ä»¥ä½ éœ€è¦çš„æŒ‡ä»¤ï¼ˆä¹Ÿå°±æ˜¯ä½ å¯ä»¥å–ç›¸å…³æŒ‡ä»¤å­—èŠ‚ç çš„ä¸€éƒ¨åˆ†æ¥æ»¡è¶³ä½ çš„éœ€æ±‚ï¼‰ï¼Œæ³¨æ„è¦æ£€ç´¢é‚£äº›ä»¥`c3`ç»“å°¾çš„å­—èŠ‚ç ï¼Œè®°å½•ä¸‹æŒ‡ä»¤çš„åœ°å€
- ç„¶åå¡«å…¥è¾“å…¥å­—ç¬¦ä¸²å³å¯ï¼ˆæ³¨æ„å°ç«¯ï¼Œè¦å€’ç€å†™ï¼‰

ç¯‡å¹…æœ‰é™ï¼Œå…·ä½“çš„è¿˜æ˜¯å‚è€ƒ[bç«™](ã€æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ attacklab-å“”å“©å“”å“©ã€‘ https://b23.tv/WyDNvzY)ï¼Œå°¤å…¶æ˜¯phase_5æœ‰äº›éš¾åº¦ï¼ŒæŒ‡ä»¤è·¨åº¦è¾ƒå¤§ï¼Œå¯„å­˜å™¨è¾ƒå¤š

## archlab

è¿™æ˜¯ä¸€ä¸ªæœ‰å…³Y86å¤„ç†å™¨æ¶æ„çš„labï¼ˆæ¥è‡ªè¯¾æœ¬çš„ç¬¬4ç« ï¼‰ï¼Œä¸€å…±A,B,Cä¸‰ä¸ªéƒ¨åˆ†ï¼Œæˆ‘åªè¯•ç€åšäº†åšå‰ä¸¤ä¸ªéƒ¨åˆ†ï¼Œæœ€åä¸€ä¸ªéƒ¨åˆ†ä¸æ„¿æ„åšäº†ï¼Œä¸»è¦æ˜¯å› ä¸ºæ„Ÿè§‰è‡ªå·±å¯¹æ±‡ç¼–ä¼˜åŒ–è¿™å—ä¸å¤ªæ•æ„Ÿï¼Œåšè¿™ä¸ªæ²¡ä»€ä¹ˆæ„æ€ã€‚ä½†æ˜¯è¿˜æ˜¯æ¢³ç†ä¸€ä¸‹å·¥ä½œæµ

### Part A

å…ˆè¿›å…¥`sim/misc`ç›®å½•æ‰§è¡Œ`make`å‘½ä»¤ï¼ˆæ³¨ï¼šæˆ‘åœ¨makeæ—¶é‡åˆ°äº†å˜é‡é‡å¤å®šä¹‰çš„é—®é¢˜ï¼Œæˆ‘ä¸çŸ¥é“å¦‚ä½•è§£å†³ï¼Œä»è€Œå¯¼è‡´ä¸€äº›æ–‡ä»¶æ— æ³•è¢«makeç”Ÿæˆï¼Œç›®å‰çš„è§£å†³æ–¹æ³•æ˜¯ï¼šåœ¨`sim/misc/yis.h`ä¸­ä¸º`int lineno;`åŠ ä¸Š`extern`è¿™æ ·ä½ å¯ä»¥`make`å‡ºpartAéœ€è¦çš„æ–‡ä»¶æ¥è¿›è¡Œæµ‹è¯•ï¼Œä½†æ˜¯PartBæˆ‘è¿˜æ²¡æœ‰è§£å†³ï¼‰

è¿™ä¸€éƒ¨åˆ†è¦æ±‚ä½ å†™ä¸‰ä¸ªy86æ±‡ç¼–ç¨‹åº

`sum.ys`ï¼šå¯¹ä¸€ä¸ªé“¾è¡¨è¿›è¡Œæ±‚å’Œ

`rsum.ys`:`sum.ys`çš„é€’å½’ç‰ˆæœ¬

`copy.ys`:å°†ä¸€ä¸ªä¸€ä¸ªå­—å—å¤åˆ¶åˆ°å†…å­˜ä¸­çš„å¦ä¸€ä¸ªå­—å—ï¼Œåº”è®¡ç®—æ‰€æœ‰å­—å—ä¸­å€¼çš„æ ¡éªŒå’Œ`xor`

å‚è€ƒçš„Cè¯­è¨€ç‰ˆæœ¬åœ¨`sim/misc/example.c`ä¸­

å¤§è‡´çš„ä»£ç æ ¼å¼å¦‚ä¸‹ï¼š

```y86
    .pos 0	# ä½ç½®æŒ‡ç¤ºç¬¦ï¼Œç”¨æ¥æŒ‡å®šæ¥ä¸‹æ¥çš„ä»£ç æˆ–æ•°æ®åœ¨å†…å­˜ä¸­çš„ç»å¯¹åœ°å€ã€‚
    irmovq stack, %rsp	# è®¾ç½®æ ˆæŒ‡é’ˆæŒ‡å‘stackåœ°å€
    call main	# è°ƒç”¨mainå‡½æ•°
    halt	# ç¨‹åºç»“æŸ


    .align 8	# å­—å¯¹é½
ele1:	#é“¾è¡¨
    .quad 0x00a
    .quad ele2
ele2:
    .quad 0x0b0
    .quad ele3
ele3:
    .quad 0xc00
    .quad 0
    
main:
    irmovq ele1, %rdi
    call list_sum
    ret

list_sum:
    pushq %rbp # ä¿å­˜rbp
    xorq %rax, %rax # æ¸…é›¶
    jmp test

loop:
    mrmovq (%rdi), %rsi 
    addq %rsi, %rax
    mrmovq 8(%rdi), %rdi
    jmp test

test:
    andq %rdi, %rdi
    jne loop
    popq %rbp
    ret

    .pos 0x200 # åœ¨å†…å­˜åœ°å€ 0x200 å¤„å®šä¹‰æ ‡ç­¾ stack
stack:	 # æ ˆåº•
```

æ‰§è¡Œ`./yas xxx.ys && ./yis xxx.yo`å‘½ä»¤å³å¯å¾—åˆ°è¾“å‡ºï¼Œæ­£ç¡®çš„è¾“å‡ºå¦‚ä¸‹

```
Stopped in 31 steps at PC = 0x13.  Status 'HLT', CC Z=1 S=0 O=0
Changes to registers:
%rax:   0x0000000000000000      0x0000000000000cba
%rsp:   0x0000000000000000      0x0000000000000200
%rsi:   0x0000000000000000      0x0000000000000c00

Changes to memory:
0x01f0: 0x0000000000000000      0x000000000000005b
0x01f8: 0x0000000000000000      0x0000000000000013
```

çœ‹%raxå³å¯åˆ¤æ–­æ˜¯å¦å¾—åˆ°æ­£ç¡®çš„ç»“æœ

æœ‰å…³å†…å­˜çš„å°±çœ‹ä¸‹é¢åŠæ®µï¼Œå†’å·å‰æ˜¯åœ°å€ï¼Œå†’å·åå‰åŠæ®µæ˜¯æ‰§è¡Œå‰çš„å€¼ï¼ŒååŠæ®µæ˜¯æ‰§è¡Œåçš„å€¼

### Part B

åœ¨`sim/seq`ç›®å½•ä¸‹ï¼ŒæŸ¥çœ‹`seq-full.hcl`æ ¹æ®æ³¨é‡Šåˆ¤æ–­ä½ æ˜¯å¦è¦æŠŠ`iadd`å¡«å…¥ç›¸åº”çš„éƒ¨åˆ†å³å¯

### Part C

è¯·å‚è€ƒ [åšå®¢](https://arthals.ink/blog/arch-lab#partc), è¯¥åšå®¢ä¹Ÿæ˜¯æˆ‘åœ¨åšè¿™ä¸ªlabæ—¶çš„å‚è€ƒ
